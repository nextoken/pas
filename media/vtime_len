#!/usr/bin/env python3
# @pas-executable
"""
Get the play length of MP4 files in a directory and sort them by duration.

Usage:
    vtime_len [directory]

If no directory is provided, it defaults to the current directory.
"""
import os
import subprocess
import sys

# Function to get the play length of an mp4 file using ffprobe
def get_video_length(file_path):
    try:
        result = subprocess.Popen(['ffprobe', '-i', file_path, '-show_entries', 'format=duration', '-v', 'quiet', '-of', 'csv=p=0'], stdout=subprocess.PIPE, stderr=subprocess.STDOUT)
        output = result.communicate()
        return float(output[0])
    except Exception:
        return 0.0

def main():
    if len(sys.argv) > 1 and sys.argv[1] in ["-h", "--help"]:
        print(__doc__)
        return

    # Directory containing the mp4 files
    directory = sys.argv[1] if len(sys.argv) > 1 else "./"

    if not os.path.isdir(directory):
        print(f"Error: Directory '{directory}' not found.")
        sys.exit(1)

    video_lengths = {}

    # Iterate over all files in the directory
    for filename in os.listdir(directory):
        if filename.endswith(".mp4"):
            file_path = os.path.join(directory, filename)
            video_lengths[filename] = get_video_length(file_path)

    if not video_lengths:
        print("No .mp4 files found.")
        return

    # Sort the video lengths dictionary by play length in descending order
    sorted_videos = sorted(video_lengths.items(), key=lambda x: x[1], reverse=True)

    total_play_length = sum(video_lengths.values())

    # Print the sorted list of videos and total play length
    for video, length in sorted_videos:
        print(f"{video}: {length:.2f} seconds")

    print(f"\nTotal play length of all videos: {total_play_length:.2f} seconds ({total_play_length/60:.2f} minutes)")

if __name__ == "__main__":
    main()